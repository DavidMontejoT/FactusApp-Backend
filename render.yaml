# Configuración de Deploy en Render para FactusApp Backend
# Spring Boot 3.2.0 + PostgreSQL

services:
  # Web Service - Backend API
  - type: web
    name: factusapp-backend
    env: java
    plan: free
    region: oregon

    # Configuración de build
    buildCommand: ./gradlew clean build -x test --no-daemon
    startCommand: java -jar build/libs/*.jar

    # Variables de entorno
    envVars:
      # Base de datos (Render configura automáticamente PG*)
      - key: SPRING_DATASOURCE_URL
        fromDatabase:
          name: factusapp-db
          property: connectionString

      - key: PGHOST
        fromDatabase:
          name: factusapp-db
          property: host

      - key: PGPORT
        fromDatabase:
          name: factusapp-db
          property: port

      - key: PGDATABASE
        fromDatabase:
          name: factusapp-db
          property: database

      - key: PGUSER
        fromDatabase:
          name: factusapp-db
          property: user

      - key: PGPASSWORD
        fromDatabase:
          name: factusapp-db
          property: password

      # Configuración del servidor
      - key: SERVER_PORT
        value: 8080

      - key: PORT
        value: 8080

      - key: JAVA_OPTS
        value: "-Xmx512m -Xms256m"

      # JWT - Generar uno nuevo para producción
      - key: JWT_SECRET
        generateValue: true
        length: 64

      - key: JWT_EXPIRATION
        value: 900000

      - key: JWT_REFRESH_EXPIRATION
        value: 604800000

      # Factus API - Configurar en Render Dashboard
      # FACTUS_API_URL, FACTUS_CLIENT_ID, FACTUS_CLIENT_SECRET
      # FACTUS_USERNAME, FACTUS_PASSWORD, FACTUS_DEMO_MODE
      # Nota: Las credenciales deben configurarse manualmente en el dashboard de Render
      # por razones de seguridad. No incluir credenciales en este archivo público.

      # CORS - Permitir frontend en Render
      - key: CORS_ORIGINS
        value: https://factusapp-frontend.onrender.com,https://factusapp-frontend.onrender.com/*

      # Logging
      - key: LOG_LEVEL
        value: INFO

    # Health check
    healthCheckPath: /api/health

    # Auto-deploy desde GitHub
    branch: main

# Base de datos PostgreSQL
databases:
  - name: factusapp-db
    databaseName: factusapp_prod
    user: factusapp
    plan: free
    region: oregon
    ipAllowList: []  # Permitir acceso solo desde servicios de Render
